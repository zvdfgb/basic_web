{% extends 'base.html' %}
{% load static %}

{% block title %}与 {{ friend.profile.nickname|default:friend.username }} 聊天 - MyBlog{% endblock %}

{% block head %}
<style>
    .chat-container {
        height: calc(100vh - 140px);
        min-height: 500px;
    }

    .friends-list {
        height: 100%;
        overflow-y: auto;
    }

    .chat-messages {
        height: calc(100% - 130px);
        overflow-y: auto;
        background-color: #f8f9fa;
    }

    .friend-item {
        transition: all 0.2s;
        cursor: pointer;
        border-left: 4px solid transparent;
    }

    .friend-item:hover {
        background-color: #f8f9fa;
    }

    .friend-item.active {
        background-color: #eef2ff;
        border-left-color: var(--primary-color, #6366f1);
    }

    .message-bubble {
        max-width: 75%;
        border-radius: 1rem;
        padding: 0.75rem 1rem;
        position: relative;
        word-wrap: break-word;
    }

    .message-sent {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }

    .message-received {
        background-color: white;
        border: 1px solid #e5e7eb;
        border-bottom-left-radius: 0.25rem;
    }
    
    /* Scrollbar Styling */
    .friends-list::-webkit-scrollbar,
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .friends-list::-webkit-scrollbar-track,
    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .friends-list::-webkit-scrollbar-thumb,
    .chat-messages::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
    }
</style>
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
{% endblock %}

{% block main %}
<div class="container-fluid px-lg-5 mb-4">
    <div class="card shadow-sm border-0 overflow-hidden chat-container">
        <div class="row g-0 h-100">
            <!-- Sidebar: Friends List -->
            <div class="col-md-4 col-lg-3 border-end h-100 d-flex flex-column bg-white">
                <!-- User Profile Header -->
                <div class="p-3 border-bottom bg-light">
                    <div class="d-flex align-items-center">
                        <a href="{% url 'mauth:profile' %}">
                            <img src="{{ request.user.profile.avatar.url }}" class="rounded-circle border border-2 border-white shadow-sm me-2" width="40" height="40" style="object-fit: cover;">
                        </a>
                        <div class="flex-grow-1 overflow-hidden">
                            <h6 class="mb-0 text-truncate fw-bold">{{ request.user.profile.nickname|default:request.user.username }}</h6>
                            <small class="text-success"><i class="bi bi-circle-fill" style="font-size: 8px;"></i> 在线</small>
                        </div>
                    </div>
                </div>

                <!-- Search -->
                <div class="p-3">
                    <div class="position-relative">
                        <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                        <input type="text" class="form-control form-control-sm ps-5 rounded-pill bg-light border-0" placeholder="搜索好友..." id="friend-search">
                    </div>
                </div>

                <!-- Friends List -->
                <div class="friends-list flex-grow-1">
                    {% for f in friends %}
                    <div class="friend-item p-3 d-flex align-items-center {% if f.user.id == friend.id %}active{% endif %}"
                        onclick="window.location.href = '{% url 'mauth:chat' f.user.id %}';" style="cursor: pointer;">
                        <div class="position-relative me-3" onclick="event.stopPropagation();">
                            <a href="{% url 'mauth:profile_view' f.user.id %}" class="text-decoration-none text-dark">
                                <img src="{{ f.user.profile.avatar.url }}" class="rounded-circle shadow-sm" width="45" height="45" style="object-fit: cover;">
                            </a>
                            <!-- Online Status Dot (Static for now, could be dynamic) -->
                            <span class="position-absolute bottom-0 end-0 p-1 bg-success border border-light rounded-circle"></span>
                        </div>
                        <div class="flex-grow-1 overflow-hidden">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="mb-0 text-truncate fw-medium">{{ f.user.profile.nickname|default:f.user.username }}</h6>
                            </div>
                            <p class="mb-0 small text-muted text-truncate">{{ f.user.profile.signature|default:"这个家伙很懒，什么都没写" }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center p-4 text-muted">
                        <p>还没有好友哦</p>
                        <a href="{% url 'mauth:friend_list' %}" class="btn btn-sm btn-outline-primary rounded-pill">去添加</a>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="col-md-8 col-lg-9 h-100 d-flex flex-column bg-white">
                <!-- Chat Header -->
                <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-white shadow-sm z-1">
                    <div class="d-flex align-items-center">
                        <div class="d-md-none me-3">
                            <a href="{% url 'mauth:friend_list' %}" class="text-muted"><i class="bi bi-arrow-left fs-4"></i></a>
                        </div>
                        <img src="{{ friend.profile.avatar.url }}" class="rounded-circle border me-3" width="40" height="40" style="object-fit: cover;">
                        <div>
                            <h6 class="mb-0 fw-bold">{{ friend.profile.nickname|default:friend.username }}</h6>
                            <small class="text-muted">{{ friend.profile.signature|default:"暂无个性签名" }}</small>
                        </div>
                    </div>
                    <div>
                        <a href="{% url 'mauth:profile_view' friend.id %}" class="btn btn-light btn-sm rounded-circle" title="查看资料">
                            <i class="bi bi-person"></i>
                        </a>
                    </div>
                </div>

                <!-- Messages -->
                <div class="chat-messages p-4" id="chat-messages">
                    {% for msg in messages %}
                    <div class="d-flex mb-3 {% if msg.sender == request.user %}justify-content-end{% endif %}">
                        {% if msg.sender != request.user %}
                        <a href="{% url 'mauth:profile_view' friend.id %}">
                            <img src="{{ friend.profile.avatar.url }}" class="rounded-circle me-2 align-self-end shadow-sm" width="32" height="32" style="object-fit: cover;">
                        </a>
                        {% endif %}

                        <div class="message-bubble shadow-sm {% if msg.sender == request.user %}message-sent{% else %}message-received{% endif %}">
                            <div class="mb-0">{{ msg.content }}</div>
                            <small class="{% if msg.sender == request.user %}text-white-50{% else %}text-muted{% endif %} opacity-75 d-block text-end mt-1" style="font-size: 0.7rem;">
                                {{ msg.timestamp|date:"H:i" }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Input Area -->
                <div class="p-3 bg-white border-top">
                    <form id="chat-form" class="position-relative">
                        {% csrf_token %}
                        <!-- Emoji Picker Popup -->
                        <div id="emoji-popup" style="display: none; position: absolute; bottom: 100%; right: 0; z-index: 10;">
                            <emoji-picker></emoji-picker>
                        </div>

                        <div class="input-group">
                            <button type="button" class="btn btn-light border text-muted" id="emoji-btn">
                                <i class="bi bi-emoji-smile"></i>
                            </button>
                            <input type="text" name="content" id="chat-input" class="form-control border-start-0 border-end-0 bg-light" placeholder="发送消息..." autocomplete="off" required>
                            <button type="submit" class="btn btn-primary-gradient px-4">
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const friendId = {{ friend.id }};
    const inputField = document.getElementById('chat-input');
    
    // Auto scroll to bottom
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    // Initial scroll
    scrollToBottom();

    // Friend Search Filter
    document.getElementById('friend-search').addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.friend-item').forEach(item => {
            const name = item.querySelector('h6').textContent.toLowerCase();
            if (name.includes(term)) {
                item.parentElement.style.display = 'block';
            } else {
                item.parentElement.style.display = 'none';
            }
        });
    });

    // Send Message
    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const content = formData.get('content').trim();
        if (!content) return;

        // Optimistic UI Update (Show message immediately)
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        
        const tempMsgHTML = `
            <div class="d-flex mb-3 justify-content-end">
                <div class="message-bubble shadow-sm message-sent">
                    <div class="mb-0">${content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
                    <small class="text-white-50 opacity-75 d-block text-end mt-1" style="font-size: 0.7rem;">${timeStr}</small>
                </div>
            </div>
        `;
        chatMessages.insertAdjacentHTML('beforeend', tempMsgHTML);
        scrollToBottom();
        this.reset();

        fetch(location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                alert('发送失败');
                // Could remove the temp message here if needed
            }
        });
    });

    // Poll for new messages
    let lastMsgCount = {{ messages.count }};
    
    function fetchMessages() {
        fetch(`/auth/chat/get_messages/${friendId}/`)
            .then(response => response.json())
            .then(data => {
                // Only update if there are new messages to avoid jitter
                // Ideally we'd compare IDs, but simple length check + rebuild or append is okay for now
                // For simplicity in this poll implementation, we will rebuild content if count differs 
                // OR just append if we implement "since_id". 
                // The current backend returns ALL messages. Let's just update content if length changed.
                
                if (data.messages.length > lastMsgCount) {
                    const currentScroll = chatMessages.scrollTop + chatMessages.clientHeight;
                    const isNearBottom = chatMessages.scrollHeight - currentScroll < 150;
                    
                    // Rebuild HTML (Not most efficient but safe)
                    // Better: Filter and append new ones. 
                    // Let's just rebuild to be safe and consistent with previous code
                    
                    chatMessages.innerHTML = data.messages.map(msg => `
                        <div class="d-flex mb-3 ${msg.is_self ? 'justify-content-end' : ''}">
                            ${!msg.is_self ? `<a href="{% url 'mauth:profile_view' friend.id %}"><img src="{{ friend.profile.avatar.url }}" class="rounded-circle me-2 align-self-end shadow-sm" width="32" height="32" style="object-fit: cover;"></a>` : ''}
                            
                            <div class="message-bubble shadow-sm ${msg.is_self ? 'message-sent' : 'message-received'}">
                                <div class="mb-0">${msg.content}</div>
                                <small class="${msg.is_self ? 'text-white-50' : 'text-muted'} opacity-75 d-block text-end mt-1" style="font-size: 0.7rem;">
                                    ${msg.timestamp.split(' ')[1].substring(0, 5)}
                                </small>
                            </div>
                        </div>
                    `).join('');
                    
                    lastMsgCount = data.messages.length;

                    if (isNearBottom) {
                        scrollToBottom();
                    }
                }
            });
    }

    setInterval(fetchMessages, 3000);

    // Emoji Picker Logic
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPopup = document.getElementById('emoji-popup');
    const picker = document.querySelector('emoji-picker');

    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPopup.style.display = emojiPopup.style.display === 'none' ? 'block' : 'none';
    });

    picker.addEventListener('emoji-click', event => {
        const emoji = event.detail.unicode;
        const start = inputField.selectionStart;
        const end = inputField.selectionEnd;
        const text = inputField.value;
        inputField.value = text.substring(0, start) + emoji + text.substring(end);
        inputField.selectionStart = inputField.selectionEnd = start + emoji.length;
        inputField.focus();
        emojiPopup.style.display = 'none';
    });

    document.addEventListener('click', (e) => {
        if (!emojiPopup.contains(e.target) && e.target !== emojiBtn) {
            emojiPopup.style.display = 'none';
        }
    });
</script>
{% endblock %}