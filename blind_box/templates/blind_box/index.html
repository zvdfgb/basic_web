{% extends 'base.html' %}
{% load static %}

{% block title %}ç¼˜åˆ†ç›²ç›’ - MyBlog{% endblock %}

{% block main %}
<style>
    /* ç›²ç›’åŒºåŸŸæ ·å¼ */
    .blind-box-container {
        min-height: 70vh; /* å æ®å¤§éƒ¨åˆ†å±å¹•é«˜åº¦ */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    /* ç›’å­æœ¬ä½“æ ·å¼ */
    .mystery-box {
        font-size: 8rem; /* ç›’å­å¤§å° */
        cursor: pointer;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        user-select: none;
        margin: 20px 0;
    }

    /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
    .mystery-box:hover {
        transform: scale(1.1) rotate(5deg);
    }

    /* ç‚¹å‡»æ—¶çš„æŠ–åŠ¨åŠ¨ç”» */
    .shake-hard {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
    }

    @keyframes shake {
        10%, 90% { transform: translate3d(-2px, 0, 0) rotate(-5deg); }
        20%, 80% { transform: translate3d(4px, 0, 0) rotate(5deg); }
        30%, 50%, 70% { transform: translate3d(-8px, 0, 0) rotate(-10deg); }
        40%, 60% { transform: translate3d(8px, 0, 0) rotate(10deg); }
    }

    .status-text {
        font-size: 1.2rem;
        color: #6c757d;
        height: 30px; /* å ä½é˜²æ­¢è·³åŠ¨ */
        font-weight: 500;
    }
</style>

<div class="blind-box-container">
    <h1 class="display-4 fw-bold text-gradient mb-3">ğŸ”® ç¼˜åˆ†ç›²ç›’</h1>
    <p class="lead text-muted mb-5">ç‚¹å‡»ä¸‹æ–¹çš„å®ç®±ï¼Œéšæœºè¿æ¥ä¸€ä½æœ‰è¶£çš„çµé­‚ã€‚</p>

    <!-- ç›²ç›’æœ¬ä½“ -->
    <div id="blindBox" class="mystery-box">ğŸ</div>

    <!-- çŠ¶æ€æç¤ºæ–‡å­— -->
    <div id="statusText" class="status-text">ç‚¹å‡»å®ç®±å¼€å§‹åŒ¹é…</div>

    <!-- éšè—çš„CSRF Tokenï¼Œç”¨äºAJAX -->
    {% csrf_token %}
</div>

<!-- å¼•å…¥ jQuery (å¦‚æœä½ çš„ base.html æ²¡å¼•å…¥çš„è¯) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        let isDrawing = false; // é˜²æ­¢é‡å¤ç‚¹å‡»

        $("#blindBox").click(function() {
            if (isDrawing) return; // å¦‚æœæ­£åœ¨æŠ½å¥–ï¼Œç›´æ¥è¿”å›
            isDrawing = true;

            const $box = $(this);
            const $status = $("#statusText");
            const csrfToken = $("input[name='csrfmiddlewaretoken']").val();

            // 1. å¼€å§‹åŠ¨ç”»
            $box.addClass("shake-hard");
            $status.text("ğŸ” æ­£åœ¨èŒ«èŒ«äººæµ·ä¸­å¯»æ‰¾æœ‰ç¼˜äºº...");
            $status.addClass("text-primary");

            // 2. æ¨¡æ‹Ÿä¸€ç‚¹å»¶è¿Ÿæ„Ÿï¼ˆ1.5ç§’ï¼‰ï¼Œè®©åŠ¨ç”»æ’­ä¸€ä¼šå„¿ï¼Œå¢åŠ ç´§å¼ æ„Ÿ
            setTimeout(function() {
                // 3. å‘é€çœŸå®è¯·æ±‚
                $.ajax({
                    url: "{% url 'blind_box:draw' %}",
                    type: "POST",
                    headers: { "X-CSRFToken": csrfToken }, // å…³é”®ï¼šå¸¦ä¸Š Token
                    success: function(res) {
                        if (res.code === 200) {
                            $status.text("ğŸ‰ åŒ¹é…æˆåŠŸï¼æ­£åœ¨è·³è½¬...");
                            $box.text("ğŸŠ"); // å˜æˆå¼€ç®±å›¾æ ‡

                            // 4. è¿™é‡Œçš„ target_id å°±æ˜¯åç«¯ä¼ å›æ¥çš„ç”¨æˆ·ID
                            let targetId = res.data.target_id;

                            // 5. å»¶è¿Ÿ 0.5ç§’ è·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åŒ¹é…æˆåŠŸçš„æç¤º
                            setTimeout(function(){
                                window.location.href = "/blind-box/chat/" + targetId + "/";
                            }, 500);

                        } else {
                            // å¤„ç†é”™è¯¯ï¼ˆæ¯”å¦‚åªæœ‰è‡ªå·±ä¸€ä¸ªäººï¼‰
                            stopAnimation(res.message);
                        }
                    },
                    error: function(xhr) {
                        stopAnimation("âŒ æœåŠ¡å™¨å¼€å°å·®äº†ï¼Œè¯·ç¨åé‡è¯•");
                        console.error(xhr.responseText);
                    }
                });
            }, 1500);
        });

        function stopAnimation(msg) {
            $("#blindBox").removeClass("shake-hard");
            $("#statusText").text(msg).removeClass("text-primary").addClass("text-danger");
            isDrawing = false;
        }
    });
</script>
{% endblock %}