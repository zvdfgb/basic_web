{% extends 'base.html' %}
{% load static %}

{% block title %}ä¸ {{ target_user.username }} å¯¹è¯ä¸­{% endblock %}

{% block main %}
<style>
    /* èŠå¤©çª—å£å®¹å™¨ */
    .chat-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.85); /* ç»ç’ƒæ‹Ÿæ€èƒŒæ™¯ */
        backdrop-filter: blur(10px);
        height: 80vh; /* å›ºå®šé«˜åº¦ */
        display: flex;
        flex-direction: column;
        margin-top: 80px;
    }

    /* é¡¶éƒ¨Header */
    .chat-header {
        background: rgba(255, 255, 255, 0.9);
        padding: 15px 20px;
        border-bottom: 0px solid rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 20;
    }

    /* èŠå¤©å†…å®¹åŒºåŸŸ */
    .chat-body {
        flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
        overflow-y: auto; /* å…è®¸æ»šåŠ¨ */
        padding: 20px;
        background-color: #f9f9f9;
        scroll-behavior: smooth;
    }

    /* æ¶ˆæ¯æ°”æ³¡é€šç”¨æ ·å¼ */
    .message-row {
        display: flex;
        margin-bottom: 20px;
        align-items: flex-end;
    }

    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* å¯¹æ–¹çš„æ¶ˆæ¯ */
    .message-row.theirs .avatar { margin-right: 12px; }
    .message-row.theirs .bubble {
        background: #ffffff;
        color: #333;
        border-radius: 18px 18px 18px 2px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* æˆ‘çš„æ¶ˆæ¯ */
    .message-row.mine { flex-direction: row-reverse; }
    .message-row.mine .avatar { margin-left: 12px; display: none; /* è‡ªå·±é€šå¸¸ä¸çœ‹è‡ªå·±å¤´åƒï¼Œå¯é€‰æ‹©æ˜¾ç¤º */ }
    .message-row.mine .bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 18px 18px 2px 18px;
        box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3);
    }

    .bubble {
        padding: 12px 16px;
        max-width: 70%;
        position: relative;
        word-wrap: break-word;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .message-time {
        font-size: 0.75rem;
        color: #aaa;
        margin-top: 5px;
        text-align: right;
        display: block;
        opacity: 0.8;
    }
    .mine .message-time { color: rgba(255,255,255,0.8); }

    /* åº•éƒ¨è¾“å…¥æ¡†åŒºåŸŸ */
    .chat-footer {
        padding: 15px 20px;
        background: white;
        border-top: 1px solid rgba(0,0,0,0.05);
    }

    .input-group-custom {
        background: #f1f3f5;
        border-radius: 30px;
        padding: 5px 10px;
        display: flex;
        align-items: center;
        border: 1px solid transparent;
        transition: 0.3s;
    }
    .input-group-custom:focus-within {
        background: white;
        border-color: #764ba2;
        box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
    }

    .form-control-chat {
        border: none;
        background: transparent;
        box-shadow: none;
        padding: 10px;
        resize: none; /* ç¦æ­¢æ‹–åŠ¨å¤§å° */
        height: 45px;
        max-height: 100px;
    }
    .form-control-chat:focus {
        background: transparent;
        box-shadow: none;
    }

    .btn-send {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #764ba2;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
        margin-left: 5px;
    }
    .btn-send:hover { background: #5e3a85; transform: scale(1.05); }
    .btn-send svg { width: 18px; height: 18px; fill: white; margin-left: 2px; }

</style>

<div class="row justify-content-center ">
    <div class="col-lg-8 col-md-10">
        <div class="chat-card">

            <!-- å¤´éƒ¨ï¼šæ˜¾ç¤ºå¯¹æ–¹ä¿¡æ¯ -->
            <div class="chat-header">
                <div class="d-flex align-items-center">
                    <div class="avatar" style="background: #e9ecef; color: #555;">
                        {{ target_user.username|slice:":1"|upper }}
                    </div>
                    <div class="ms-3">
                        <h5 class="mb-0 fw-bold">{{ target_user.username }}</h5>
                        <small class="text-success">â— åœ¨çº¿</small>
                    </div>
                </div>
                <a href="{% url 'blind_box:index' %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
                    ğŸ² æ¢ä¸ªäºº
                </a>
            </div>

            <!-- ä¸­é—´ï¼šæ¶ˆæ¯åˆ—è¡¨ -->
            <div class="chat-body" id="chatContainer">
                {% for msg in messages %}
                    {% if msg.sender == request.user %}
                        <!-- æˆ‘çš„æ¶ˆæ¯ -->
                        <div class="message-row mine">
                            <div class="bubble">
                                {{ msg.content }}
                                <span class="message-time">{{ msg.created_at|date:"H:i" }}</span>
                            </div>
                        </div>
                    {% else %}
                        <!-- å¯¹æ–¹çš„æ¶ˆæ¯ -->
                        <div class="message-row theirs">
                            <div class="avatar">{{ target_user.username|slice:":1"|upper }}</div>
                            <div class="bubble">
                                {{ msg.content }}
                                <span class="message-time">{{ msg.created_at|date:"H:i" }}</span>
                            </div>
                        </div>
                    {% endif %}
                {% empty %}
                    <div class="text-center text-muted mt-5 empty-tip">
                        <p>ğŸ‰ åŒ¹é…æˆåŠŸï¼</p>
                        <p>å¿«æ‰“ä¸ªæ‹›å‘¼ï¼Œå¼€å¯ä¸€æ®µç¼˜åˆ†å§~</p>
                    </div>
                {% endfor %}
            </div>

            <!-- åº•éƒ¨ï¼šå‘é€æ¡† -->
            <div class="chat-footer">
                <form id="chatForm">
                    {% csrf_token %}
                    <div class="input-group-custom">
                        <input type="text" id="msgInput" name="content" class="form-control form-control-chat" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
                        <button type="submit" class="btn-send">
                            <!-- å‘é€å›¾æ ‡SVG -->
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        const $container = $("#chatContainer");
        const $input = $("#msgInput");

        // 1. è‡ªåŠ¨æ»šåˆ°åº•éƒ¨å‡½æ•°
        function scrollToBottom() {
            $container.animate({ scrollTop: $container[0].scrollHeight }, 300);
        }

        // é¡µé¢åŠ è½½å®Œå…ˆæ»šä¸€æ¬¡
        scrollToBottom();

        // 2. ç›‘å¬è¡¨å•æäº¤ (AJAX å‘é€)
        $("#chatForm").submit(function(e) {
            e.preventDefault(); // é˜»æ­¢é¡µé¢åˆ·æ–°

            let content = $input.val().trim();
            if (!content) return;

            let csrfToken = $("input[name='csrfmiddlewaretoken']").val();

            $.ajax({
                url: window.location.href, // æäº¤ç»™å½“å‰ URL
                type: "POST",
                data: {
                    'content': content,
                    'csrfmiddlewaretoken': csrfToken
                },
                success: function(res) {
                    if (res.code === 200) {
                        // ç§»é™¤ç©ºçŠ¶æ€æç¤º
                        $(".empty-tip").remove();

                        // 3. åŠ¨æ€æ‹¼æ¥ HTML (æ¨¡æ‹Ÿæˆ‘çš„æ¶ˆæ¯)
                        let html = `
                            <div class="message-row mine">
                                <div class="bubble">
                                    ${escapeHtml(res.data.content)}
                                    <span class="message-time">${res.data.time}</span>
                                </div>
                            </div>
                        `;

                        // è¿½åŠ å¹¶æ»šåŠ¨
                        $container.append(html);
                        scrollToBottom();

                        // æ¸…ç©ºè¾“å…¥æ¡†
                        $input.val('').focus();
                    } else {
                        alert(res.message);
                    }
                },
                error: function() {
                    alert("å‘é€å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯");
                }
            });
        });

        // ç®€å•çš„ HTML è½¬ä¹‰é˜²æ­¢ XSS
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    });
</script>
{% endblock %}